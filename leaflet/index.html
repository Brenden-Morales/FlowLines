<!DOCTYPE html>
<html lang="en" style="width:100%;height:100%;padding:0px;margin:0px">
<head>
    <meta charset="UTF-8">
    <title>Leaflet Test</title>
</head>
<body style="width:100%;height:100%;padding:0px;margin:0px">
    <div id="map" style="position:absolute;top:0px;left:0px;z-index:1;width:100%;height:100%;padding:0px;margin:0px;"></div>
    <canvas id="canvas" style="position:absolute;top:0px;left:0px;z-index:2;width:100%;height:100%;padding:0px;margin:0px;pointer-events:none"></canvas>
</body>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<script src="leaflet-src.js"></script>
<script>

    var makeUrl = function(bounds){
        var bbox =  "(" + bounds.getSouth() + "," + bounds.getWest() + "," + bounds.getNorth() + "," + bounds.getEast() + ");";
        var steps = [
            '[out:json];',
            'way',
            '["highway"~"trunk|primary|secondary|residential|service|unclassified"]',
            '["oneway"="yes"]',
            '["area"!~"."]',
            bbox,
            '(._;>;);',
            'out;'
        ];
        var url = 'http://overpass.osm.rambler.ru/cgi/interpreter?data=\n[out:json];\nway\n["highway"~"trunk|primary|secondary|residential|service|unclassified"]\n["oneway"="yes"]\n["area"!~"."]\n' + bbox + '\n(._;>;);\nout;';
        return "http://overpass.osm.rambler.ru/cgi/interpreter?data=" + steps.join("");
    };

    var map = L.map('map').setView([40.757081, -73.984365], 18);
    var canvasImageLayer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18,
        id: 'brendenmorales.o25eegf6',
        accessToken: 'pk.eyJ1IjoiYnJlbmRlbm1vcmFsZXMiLCJhIjoiY2lnZ3l4YzR1ODQ1eXZvbHVzNWV3MnNzaiJ9.5PTcNsA-WpPRADoUurkZTA'
    }).addTo(map);

    var canvasTiles = L.tileLayer.canvas({
        tileSize : 512
    }).addTo(map);

    canvasTiles.on("tileload",function(event){
        var tile = event.tile;
        var context = tile.getContext("2d");

        if(map.getZoom() > 10){

            var nwPoint = L.latLng(map.unproject(tile._tilePoint.multiplyBy(512), map.getZoom()));
            var sePoint = L.latLng(map.unproject(tile._tilePoint.multiplyBy(512).add(new L.Point(512, 512)), map.getZoom()));
            var bounds = L.latLngBounds(L.latLng(sePoint.lat,nwPoint.lng), L.latLng(nwPoint.lat,sePoint.lng));
            var url = makeUrl(bounds);

            var doProjection = function(point) {
                var s = {
                    x : tile._tilePoint.x * 512,
                    y : tile._tilePoint.y * 512
                };
                var p = map.project({
                    lat : point[1],
                    lng : point[0]
                }, this.zoom);
                return {
                    x : Math.round(p.x - s.x),
                    y : Math.round(p.y - s.y)
                };
            };


            var request = new XMLHttpRequest();
            request.doProjection = doProjection.bind(this);
            request.tile = tile;
            request.open("GET",url);
            request.onload = function(event){
                var response = JSON.parse(this.responseText);
                var nodes = {};
                var ways = [];

                for(var i = 0; i < response.elements.length;i++){
                    var element = response.elements[i];
                    if(element.type === "node"){
                        nodes[element.id] = this.doProjection([element.lon,element.lat]);
                    }
                    else if (element.type === "way"){
                        ways.push(element.nodes.map(function(obj){return obj.toString()}));
                    }
                }
                var context = this.tile.getContext("2d");
                context.strokeStyle="#FF0000";
                context.lineWidth = 5;
                for(var i = 0; i < ways.length; i ++){
                    var way = ways[i]
                    context.beginPath();
                    context.moveTo(nodes[way[0]].x,nodes[way[0]].y);
                    for(var j = 1; j < way.length; j ++){
                        var node = nodes[way[j]];
                        context.lineTo(node.x,node.y);
                    }
                    context.stroke();
                }

            };
            request.send();
        }
    });
</script>
</html>