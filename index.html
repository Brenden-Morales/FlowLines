<!DOCTYPE html>
<html lang="en" style="width:100%;height:100%;padding:0px;margin:0px;">
<head>
    <meta charset="UTF-8">
    <title>Flow Map Test</title>
</head>

<script id="passThroughVertex" type="x-shader/x-vertex">
    void main()	{
        gl_Position = vec4( position, 1.0 );
    }
</script>

<script id="passThroughFragment" type="x-shader/x-fragment">
    uniform vec2 resolution;
    uniform sampler2D texture;
    void main(){
        vec2 pos = gl_FragCoord.xy / resolution;
        vec4 color = texture2D(texture,pos);
        gl_FragColor = color;
    }
</script>

<script id="flowMapFragment" type="x-shader/x-fragment">
    uniform sampler2D segments;

    //http://stackoverflow.com/questions/849211/shortest-distance-between-a-point-and-a-line-segment
    float getDistanceToLine(vec2 v,vec2 w,vec2 p)
    {
        //Return minimum distance between line segment vw and point p
        float l2 = pow(distance(v, w),2.0);  // i.e. |w-v|^2 -  avoid a sqrt
        if (l2 == 0.0) return distance(p, v);   // v == w case
        // Consider the line extending the segment, parameterized as v + t (w - v).
        // We find projection of point p onto the line.
        // It falls where t = [(p-v) . (w-v)] / |w-v|^2
        float t = dot(p - v, w - v) / l2;
        if (t < 0.0) return distance(p, v);       // Beyond the 'v' end of the segment
        else if (t > 1.0) return distance(p, w);  // Beyond the 'w' end of the segment
        vec2 projection = v + t * (w - v);  // Projection falls on the segment
        return distance(p, projection);
    }

    //get the directional color,
    //red is x, green is y
    vec4 getLineColor(vec2 point1, vec2 point2)
    {
        return vec4(normalize(point2 - point1),0.0,1.0);
    }

    void main(){
        vec4 pixelColor = vec4(0.0,0.0,0.0,0.0);

        bool inBounds = false;
        //loop through segments
        const float delta = 1.0 / 8.0;
        for(float currentY = 0.0; currentY < 1.0; currentY += delta){
            for(float currentX = delta; currentX < 1.0; currentX += delta * 2.0){
                vec4 currentVertex = texture2D(segments,vec2(currentX,currentY));
                vec4 previousVertex = texture2D(segments,vec2(currentX - delta,currentY));
                if(currentVertex.a == 1.0 && previousVertex.a == 1.0){
                    float distanceToLine = getDistanceToLine(previousVertex.xy,currentVertex.xy,gl_FragCoord.xy);
                    inBounds = distanceToLine < 2.5;
                    if(!inBounds)continue;
                    vec4 lineColor = getLineColor(previousVertex.xy,currentVertex.xy);
                    pixelColor += vec4(lineColor * float(inBounds));
                    if(inBounds)break;
                }
            }
            if(inBounds)break;
        }

        vec2 point1 = vec2(100.0,100.0);
        vec2 point2 = vec2(500.0,500.0);

        //get the color of the line
        vec4 lineColor = getLineColor(point1,point2);

        //get the distance for this pixel to the line
        float distanceToLine = getDistanceToLine(point1,point2,gl_FragCoord.xy);

        //check to see if this pixel is within the bounds of the line
        inBounds = distanceToLine < 5.0;

        gl_FragColor = vec4(lineColor * float(inBounds));
        gl_FragColor = vec4(normalize(pixelColor.xyz),pixelColor.w);
    }
</script>

<body style="width:100%;height:100%;padding:0px;margin:0px;overflow:hidden" onload="initialize()">
    <canvas id="mainCanvas" style="position:absolute;z-index:1;width:100%;height:100%;padding:0px;margin:0px;" onclick="canvasClick(event,this)"></canvas>
    <canvas id="renderCanvas" style="position:absolute;z-index:2;width:100%;height:100%;padding:0px;margin:0px;pointer-events:none;display:none"></canvas>
    <div id="overlay" style="position:relative;z-index:3;width:100%;height:100%;padding:0px;margin:0px;pointer-events:none">
        <div style="padding-top: 50px;">
            Line Width:
            <select id="lineThickness" style="pointer-events:all" onchange="lineThicknessChanged()">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20" selected="selected">20</option>
            </select>
        </div>
        <div >
            <button id="toggleRender" style="pointer-events:all" onclick="toggleRender()">Not Rendering</button>
        </div>
        <div>
            <input type="number" name="time" min="0" max="1" step="0.1" value="0" style="pointer-events:all" onchange="updateTime(value)">
        </div>
    </div>
</body>

<script src="libs/Three.js"></script>
<script src="main.js"></script>
<script src="FancyStuff.js"></script>
<script src="libs/stats.min.js"></script>
<script src="TextureRenderer.js"></script>
<script src="SegmentTexture.js"></script>
</html>